
```{r termination_load_pkgs, echo=FALSE, message=FALSE, include=FALSE}

# # Load packages
library('broom')
library("papaja")
library('reticulate')
library('tidyverse')
library('cowplot')
library('MESS') # for AUCs
library('lsr') # for effect sizes
library('pwr') # for power calculations
library('brms') # for mixed effects modeling
library('BayesFactor') # for Bayesian t test
library('jsonlite') #parsing data from sort_trial
library('thesisdown')
library('knitr')
# r_refs("r-references.bib")


knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

# Efficient search termination without task experience: the role of second-order knowledge about visual search {#ch-termination}

#### Matan Mazor & Stephen M. Fleming {.unnumbered}

As a general rule, if it is easy to detect a target in a visual scene, it is also easy to detect its absence. To account for this, models of visual search explain search termination as resulting either from counterfactual reasoning over second-order representations of search efficiency, automatic extraction of ensemble statistics of a display, or heuristic adjustment of a search termination strategy based on previous trials. Traditional few-subjects/many-trials lab-based experiments render it impossible to disentangle the unique contribution of these different processes to absence pop-out - the immediate recognition that a feature is missing from a display. In two pre-registered large-scale online experiments (N1=1187, N2=887) we show that search termination times are already aligned with target identification times in the very first trials of the experiment, before any experience with target presence. Exploratory analysis reveals that second-order knowledge about search efficiency can be used to guide decisions about search termination even if it is not available for explicit report. We conclude that for basic stimulus properties, efficient inference about absence is independent of task experience, and relies instead on implicit second-order knowledge.

## Introduction 

Searching for the only blue letter in an array of yellow letters is easy, but searching for the only blue X in an array of yellow Xs and blue Ts is much harder [@treisman1980feature]. This difference manifests in the time taken to find the target letter, but also in the time taken to conclude that the target letter is missing. In other words, easier searches not only make it easier to detect the presence of a target, but also to infer its absence. Differences in the speed of detecting the presence of a target have been attributed to pre-attentional mechanisms [@treisman1980feature] and guiding signals [@wolfe2007guided; @wolfe2021guided] that can sometimes make the target item 'pop out' immediately without any attentional effort. In target-absent trials, however, there is nothing in the display to pop out. This raises a fundamental question: what makes some decisions about target absence easier than others?

Models of search termination offer three classes of answers to this question, based on counterfactual reasoning, ensemble perception, and task heuristics. According to counterfactual models, decisions about target absence are guided by prior beliefs about search efficiency ("If it were present, I would have found the red book by now"). These comprise beliefs about regularities in the environment ("it it were present, the book would have been on this shelf"), and second-order beliefs about one's own perception and attention ("the red cover would have immediately drawn my attention"). In recent versions of the Guided Search model [@wolfe2012quit; @wolfe2021guided], for example, search termination is triggered by a noisy quitting signal accumulator reaching a *quitting threshold*, which can be adapted to maximize long-time search efficiency, and be affected by prior second-order beliefs about the effects of set size and crowding on search difficulty [@wolfe2012quit]. Similarly, in Competitive Guided Search, the probability of terminating a search is a function of several factors, including a free parameter that indexes counterfactual beliefs about finding a target, had it been present [@moran2013competitive]. Finally, in a fixation-based model of visual search, the number of items that are concurrently scanned within a single fixation (the *functional visual field*) depends on the expected difficulty of finding a hypothetical target: with more items for easy searches and fewer items for more difficult ones [@hulleman2017impending]. 

Ensemble perception accounts of visual search postulate that some global properties of a display can be extracted automatically and immediately, and that in some cases these global properties are sufficient to conclude that a target is absent. For example, according to Feature Integration Theory, pre-attentive activation in *feature maps* can provide participants with information about the presence or absence of a feature in the display [@treisman1980feature]. The absence of a relevant feature is then sufficient to make an immediate 'target absent' decision, without processing any individual stimulus. 

Finally, heuristic-based models suggest that quitting parameters are acquired by participants as they perform a task, sometimes by following very simple rules. For example, in one model, an internal *activation threshold* decreases following incorrect and increases following correct 'no' responses [@chun1996just]. A higher activation threshold results in the scanning of less distractors, giving rise to shorter search times for easier searches. This simple heuristic provides an excellent fit to data from a visual search task with hundreds of trials, and does so without requiring that subjects hold any prior knowledge or expectations about search efficiency.

In traditional visual search experiments, where participants perform hundreds of trials of similar searches, it is impossible to disentangle the contributions of these three putative mechanisms to search termination. Yet, the three accounts make different predictions for the earliest trials of a visual search experiment, where participants encounter the stimuli for the first time. In these trials, quitting time cannot reflect the adaptive adjustment of a threshold based on previous trials, or the statistical learning of regularities in the experiment. Instead, efficient search termination without task experience must rely on an immediate perception of ensemble properties of the display, prior second-order knowledge about one's own search efficiency, or a combination of both. 

<!-- . This makes search time in the first few trials of a task a critical window into participantsâ€™ metacognitive knowledge about attention and visual search. Furthermore, participants' ability to learn from positive examples (target-present trials), and their ability to generalize their knowledge across stimulus types and displays, offers an opportunity to study the structure of this simplified metacognitive knowledge, its building blocks, and the inductive biases that guide its acquisition. In this study, we use target-absent trials in visual search to ask what participants know about their spatial attention before engaging with the visual search task, and how this knowledge is built and expanded based on experience. -->

In two pre-registered experiments we focus on feature search for colour and shape. Focusing on the first four trials of the task, we ask whether prior experience with the task and stimuli is necessary for efficient search termination in feature searches. Unlike typical visual search experiments that comprise hundreds or thousands of trials, here we collect only a handful of trials from a large pool of online participants. This unusual design allows us to reliably identify search time patterns in the first trials of the experiment. By making sure that the first displays do not include the target stimulus, we are able to ask what knowledge is available to participants about their expected search efficiency prior to engaging with the task. 

To anticipate our results, we find that efficient search termination for single features does not depend on task experience. In an exploratory analysis on a subset of participants, we further show that efficient search termination is also independent of explicit metacognitive knowledge about the task. We argue that without second-order knowledge about one's own perception and attention, ensemble perception alone is not sufficient for efficient search termination, and interpret our results as revealing a role for implicit second-order knowledge of search efficiency in search termination.

<!-- We dub this approach *zero-shot search termination* in a tribute to the study of 'zero-shot learning' in machine learning: the ability to classify unseen categories of stimuli, based on generalizable knowledge from other categories [@xian2017zero]. Efficient (i.e., fast and accurate) quitting in target-absent trials prior to any target-present trials would indicate that knowledge about the salience of a divergent color or shape is available at some form in the cognitive system, and that this knowledge can flexibly be put to use for counterfactual reasoning in the process of inference about absence. Conversely, inefficient search in these first trials would mean that positive experience is necessary for this knowledge to be acquired, or to be expressed.  -->

<!-- In the experiments outlines below, target-present trials are used as learning samples (where subjects observe how efficiently they can find a target), and target-absent trials are used as test trials (where subjects terminate the search when they believe a target would have been found). By testing participants' prior knowledge state, and their ability to learn and generalize from a few positive samples, we lay the groundwork for building a model of the Visual Search Schema. -->

 
```{r termination_load_and_format_data, echo=FALSE, cache=TRUE}

E1.df <- read_csv('data/termination/exp1/jatos_results_batch1.csv', lazy=FALSE) %>%
  rename('subj_id' = 'subject_identifier') %>%
  mutate(subj_id=factor(subj_id))

E1.export <- read_csv('data/termination/exp1/prolific_export_batch1.csv', lazy=FALSE) %>%
  filter(status=='APPROVED')

E1.N_total <- E1.df$subj_id%>%unique()%>%length()

E1.search_df <- E1.df %>%
  filter((test_part=='absence1') | 
           (test_part=='absence2') | 
           (test_part=='presence1')) %>%
  dplyr::select('subj_id','test_part','set_size','target_present','correct','RT','search_type') %>%
  #response was not coded directly, so is instead inferred from accuracy and stimulus
  mutate(response = ifelse(correct==1, target_present, 1-target_present)) %>%
  #in order to correct for serial position effects, I'm extracting a centered serial
  #position value for each trial in a block (-1.5,-0.5,0.5,1.5)
  mutate(trial = sequence(rle(as.character(subj_id))$lengths),
         i = trial%%4,
         i = ifelse(i==0,1.5,i-2.5),
         #convert to factor
         test_part = factor(test_part, levels = c('absence1','presence1','absence2')),
         search_type = factor(search_type, levels = c('conjunction','color')))

#Exclusion parameters:
minRT <- 250
maxRTsubj <- 5000 # for subject exclusion
maxRTtrial <- 1000 #for trial exclusion
min_acc_search <- 5/6

#Obtain list of excluded subjects
E1.excluded <- E1.search_df %>%
  group_by(subj_id) %>%
  summarise(acc = mean(correct),
            RTlow = quantile(RT,0.25),
            RThigh = quantile(RT,0.75)) %>%
  filter(acc<min_acc_search | RTlow<minRT | RThigh>maxRTsubj) %>%
  dplyr::select('subj_id')


#Obtain list of excluded subjects
E1_no_RT_exc.excluded <- E1.search_df %>%
  group_by(subj_id) %>%
  summarise(acc = mean(correct)) %>%
  filter(acc<min_acc_search) %>%
  dplyr::select('subj_id')

#A function to control for within-block slope effects of serial order
correctOrderEffects <- function(df) {
  fit <- lm(RTfiltered ~ i, data=df)
  slope = fit$coefficients[2];
  return(df$RTfiltered-slope*(df$i))
}

#Correct order effects
E1.search_df <- E1.search_df %>%
  mutate( include=RT>minRT & 
            RT<maxRTtrial & 
            correct==1 & 
            !subj_id%in%E1.excluded$subj_id,
          RTfiltered = ifelse(include, RT, NA)) %>%
  group_by(test_part) %>%
  do(mutate(.,RTcorrected = correctOrderEffects(.)))

#Correct order effects
E1_no_RT_exc.search_df <- E1.search_df %>%
  mutate( include= correct==1 & 
            !subj_id%in%E1_no_RT_exc.excluded$subj_id,
          RTfiltered = ifelse(include, RT, NA)) %>%
  group_by(test_part) %>%
  do(mutate(.,RTcorrected = correctOrderEffects(.)))

E1.descriptives <- E1.search_df %>% 
  filter(!subj_id%in%E1.excluded$subj_id) %>%
  group_by(subj_id) %>%
  summarise(accuracy=mean(correct), RT=median(RT));

E1.num_RT_exclusion_per_s <- E1.search_df %>%
  filter(RT>maxRTtrial | RT<minRT) %>%
  group_by(subj_id) %>%
  tally() %>%pull(n) %>%
  mean()

E1.num_error_exclusion_per_s <- E1.search_df %>%
  filter(correct==0) %>%
  group_by(subj_id) %>%
  tally() %>%pull(n) %>%
  mean()
```

## Experiment 1
In Experiment 1, we examined search termination in the case of colour search. When searching for a deviant colour, the number of distractors has virtually no effect on search time [*colour pop-out*; e.g., @d1991color], for both 'target present' and 'target absent' responses. Here we asked whether efficient quitting in colour search (*color absence pop-out*) is dependent on task experience. A detailed pre-registration document for Experiment 1 can be accessed at [osf.io/yh82v/](osf.io/yh82v/).

### Participants

The research complied with all relevant ethical regulations, and was approved by the Research Ethics Committee of University College London (study ID number 1260/003). `r E1.N_total` Participants were recruited via Prolific, and gave their informed consent prior to their participation. They were selected based on their acceptance rate (>95%) and for being native English speakers. Following our pre-registration, we collected data until we reached 320 included participants for each of our pre-registered hypotheses (after applying our pre-registered exclusion criteria). The entire experiment took around 3 minutes to complete (median completion time: `r printnum(E1.export$time_taken%>%median()/60)` minutes). Participants were paid \Â£0.38 for their participation, equivalent to an hourly wage of \Â£ `r printnum(0.38*3600/E1.export$time_taken%>%median())`.

### Procedure

A static version of Experiment 1 can be accessed on [matanmazor.github.io/termination](matanmazor.github.io/termination/experiments/demos/exp1/). Participants were first instructed about the visual search task. Specifically, that their task is to report, as accurately and quickly as possible, whether a target stimulus was present (press 'J') or absent (press 'F'). Then, practice trials were delivered, in which the target stimulus was a rotated *T*, and distractors rotated *L*s. The purpose of the practice trials was to familiarize participants with the structure of the task. For these practice trials the number of items was always 3. Practice trials were delivered in short blocks of 6 trials each, and the main part of the experiment started only once participants responded correctly on at least five trials in a block (see Figure \@ref(fig:termination-design)). 


```{r termination-design, echo=FALSE,out.width="60%",fig.cap="Experimental design. Top panel: each visual search trial started with a screen indicating the target stimulus. The search display remained visible until a response was recorded. To motivate accurate responses, the feedback screen remained visible for one second following correct responses and for four seconds following errors. Middle panel: after reading the instructions, participants practiced the visual search task in blocks of 6 trials, until they had reached an accuracy level of 0.83 correct or higher (at most one error in a block of 6 trials). Bottom panel: the main part of the experiment comprised 12 trials only, in which the target was a red dot. Unbeknown to subjects, only trials 5-8 (Block 2) were target-present trials, and the remaining trials were target-absent trials. Each 4-trial block followed a 2 by 2 design, with factors being set size (4 or 8) and distractor type (color or conjunction; blue dots only or blue dots and red squares, respectively).", fig.scap="Search termination without task experience: experimental design."}
knitr::include_graphics("figure/termination/designExp1.png")
```

In the main part of the experiment, participants searched for a red dot among blue dots or a mixed array of blue dots and red squares. Set size was set to 4 or 8, resulting in a 2-by-2 design (search type: color or color$\times$shape, by set size: 4 or 8). Critically, and unbeknown to subjects, the first four trials were always target-absent trials (one of each set-size $\times$ search-type combination), presented in randomized order. These trials were followed by the four corresponding target-present trials, presented in randomized order. The final four trials were again target-absent trials, presented in randomized order.

### Randomization

The order and timing of experimental events was determined pseudo-randomly by the Mersenne Twister pseudorandom number generator, initialized in a way that ensures registration time-locking [@mazor2019novel]. 

### Data analysis

#### Rejection criteria

Participants were excluded for making more than one error in the main part of the experiment, or for having extremely fast or slow reaction times in one or more of the tasks (below 250 milliseconds or above 5 seconds in more than 25% of the trials). 

Error trials, and trials with response times below 250 milliseconds or above 1 second were excluded from the response-time analysis. All pre-registered analyses without RT-based exclusion are reported in appendix \@ref(app1-RT).  

#### Data preprocessing

To control for within-block trial order effects, a linear regression model was fitted separately for each block and participant, predicting search time as a function of trial serial order within the block ($RT \sim \beta_0+\beta_1i$, with $i$ denoting the mean-centered serial position within a block). Search times were corrected by subtracting the product of the slope and the mean-centered serial position, in a block-wise manner.

Subject-wise search slopes were then extracted for each combination of search type (color or conjunction) and block number by fitting a linear regression model to the reaction time data with one intercept and one set-size term.

#### Hypotheses and analysis plan

Experiment 1 was designed to test several hypotheses about the contribution of metacognitive knowledge to search termination, the state of this knowledge prior to engaging with the task, and the effect of experience on this metacognitive knowledge. The specifics of our pre-registered analysis can be accessed in the following link: [https://osf.io/ea385](https://osf.io/ea385). We outline some possible search time patterns and their pre-registered interpretation in Fig. \@ref(fig:termination-models). 


```{r termination-models, echo=FALSE, out.width="100%",fig.cap="Visualization of Hypotheses. Top left: typical search times in visual search experiments with many trials (where TP = Target Present responses; TA = Target Absent responses). Set size (x axis) affects search time in conjunction search, but much less so in color search. However, it is unclear whether this pattern also holds in the first target-absent trials in an experiment. Different models make different predictions about target-absent search times in the first block of the experiment. Top right: one possibility is that the same qualitative pattern will be observed in our design, with an overall decrease in response time as a function of trial number. This would suggest that the second-order knowledge necessary to support efficient inference about absence was already in place before engaging with the task. Bottom left: an alternative pattern is that the same qualitative pattern will be observed for blocks 2 and 3, but not in block 1. This would suggest that for inference about absence to be efficient, participants had to first experience some target-present trials. Bottom right: alternatively, some degree of second-order knowledge may be available prior to engaging with the task, with some being acquired by subsequent exposure to target-present trials. This would manifest as different slopes for conjunction and color searches in blocks 1 and a learning effect for color search between blocks 1 and 3.", fig.scap="Pre-registered termination models and the predictions they make for the first trials."}
knitr::include_graphics("figure/termination/models.png")
```


Analysis comprised a positive control based on target-present trials, a test of the presence of a pop-out effect for target-absent color search in block 1, and a test for the change in slope for target-absent color search between blocks 1 and 3. All hypotheses were tested using a within-subject t-test, with a significance level of 0.05. 
Given the fact that we only have one trial per cell, one excluded trial is sufficient to make some hypotheses impossible to test on a given participant. For this reason, for each hypothesis separately, participants were included only if all necessary trials met our inclusion criteria. This meant that some hypotheses were tested on different subsets of participants.

#### Transparency and Openness

We report how we determined our sample size, all data exclusions (if any), all manipulations, and all measures in the study. We used `r cite_r("r-references.bib", pkgs=c('ggplot2','reticulate', 'cowplot','dplyr','papaja','tidyr','MESS', 'jsonlite', 'lsr', 'BayesFactor', 'pwr'), withhold=FALSE)` for all our analyses. A detailed pre-registration document for Experiment 1 can be accessed at [osf.io/yh82v/](osf.io/yh82v/). All analysis scripts and anonymized data are available at [github.com/matanmazor/termination](github.com/matanmazor/termination).

### Results

```{r termination_analyze_data, echo=FALSE, cache=TRUE}

N_perm <- 1000;
bootstrap_error <- function(x, N_perm) {
  N <- length(x)
  medians = c();
  for (i in 1:N_perm) {
    medians = c(medians,sample(x,replace=TRUE,size=N)%>%median())
  };
  return(sd(medians))
}

E1.median_search_times <- E1.search_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(median_RT= median(RTcorrected), 
            sem_RT=bootstrap_error(RTcorrected,N_perm))%>%
  #since we are only looking at correct responses
  mutate(response=test_part=='presence1')

E1.mean_acc <- E1.search_df %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_acc=mean(correct))%>%
  mutate(response=test_part=='presence1')

E1.search_slopes <- E1.search_df %>%
  filter(include==1) %>%
  group_by(subj_id,search_type,test_part) %>%
  do(model=lm(RTcorrected~set_size,data=.)) %>%
  mutate(tidys=list(broom::tidy(model))) %>%
  unnest(tidys) %>%
  # we are interested in the slope, i.e., the effect of set size.
  filter(term=='set_size')

E1.mean_search_slopes <- E1.search_slopes %>%
  group_by(search_type,test_part) %>%
  summarise('mean_slope'=mean(estimate,na.rm=TRUE),
            'se_slope' = se(estimate, na.rm=TRUE))

E1.slopes_wide <- pivot_wider(E1.search_slopes,
                           id_cols = 'subj_id',
                           names_from = c('search_type','test_part'),
                           values_from = estimate)
```

Overall mean accuracy was `r printnum(mean(E1.descriptives$accuracy))` (standard deviation =`r printnum(sd(E1.descriptives$accuracy))`). Median reaction time was `r printnum(median(E1.descriptives$RT))` ms (median absolute deviation = `r printnum(mad(E1.descriptives$RT))`). In all further analyses, only correct trials with response times between 250 and 1000 ms are included. 

*Hypothesis 1 (positive control)*: Search times in block 2 (target-present) followed the expected pattern, with a steep slope for conjunction search (`r apa_print(t.test(E1.slopes_wide$conjunction_presence1,na.rm=TRUE))$estimate`) and a shallow slope for color search (`r apa_print(t.test(E1.slopes_wide$color_presence1,na.rm=TRUE))$estimate`; see middle panel in Fig. \@ref(fig:termination-resultsMain)A). Color search slope was significantly lower than 10 ms/item and thus met our criterion for being considered 'pop-out' (`r apa_print(t.test(E1.slopes_wide$color_presence1,na.rm=TRUE,mu=10,alternative='less'))$statistic`). Furthermore, the difference between the slopes was significant (`r apa_print(t.test(E1.slopes_wide$conjunction_presence1-E1.slopes_wide$color_presence1,na.rm=TRUE))$statistic`). This positive control served to validate our method of using two trials per participant for obtaining reliable group-level estimates of search slopes.

*Hypothesis 2*: Our central focus was on results from block 1 (target-absent). Here participants didn't yet have experience with searching for the red dot. Similar to the second block, conjunction search slope was steep (`r apa_print(t.test(E1.slopes_wide$conjunction_absence1,na.rm=TRUE))$estimate`). A clear pop-out effect for color absence was also evident (`r apa_print(t.test(E1.slopes_wide$color_absence1,na.rm=TRUE,mu=10, alternative='less'))$full_result`). Furthermore, the average search slope for color search in this first block was significantly different from that of the conjunction search (`r apa_print(t.test(E1.slopes_wide$conjunction_absence1-E1.slopes_wide$color_absence1,na.rm=TRUE))$statistic`; see leftmost panel in Fig. \@ref(fig:termination-resultsMain)A), indicating that a color-absence pop-out is already in place prior to direct task experience. This result is in line with the *prior-knowledge only* model (see Fig. \@ref(fig:termination-models)), in which participants have valid expectations for efficient color search, prior to engaging with a task.

Pre-registered hypotheses 3-5 were designed to test for a learning effect between blocks 1 and 3, before and after experience with observing a red target among blue distractors. Given the overwhelming pop-out effect for target-absent trials in block 1, not much room for additional learning remained. Indeed, results from these tests support a prior-knowledge only model.

*Hypothesis 3*: Like in the first block, in the third block color search complied with our criterion for 'pop-out'  (`r apa_print(t.test(E1.slopes_wide$color_absence2,na.rm=TRUE,mu=10, alternative='less'))$full_result`), and was significantly different from the conjunction search slope (`r apa_print(t.test(E1.slopes_wide$conjunction_absence2-E1.slopes_wide$color_absence2,na.rm=TRUE))$statistic`; see rightmost panel in Fig. \@ref(fig:termination-resultsMain)A). This result is not surprising, given that a pop-out effect was already observed in block 1.

*Hypothesis 4*: To quantify the learning effect for color search, we directly contrasted the search slope for color search in blocks 1 and 3. We find no evidence for a learning effect (`r apa_print(t.test(E1.slopes_wide$color_absence1-E1.slopes_wide$color_absence2,na.rm=TRUE))$statistic`). Furthermore, a Bayesian t-test with a scaled Cauchy prior for effect sizes (r=0.707) provided strong evidence in favour of the absence of a learning effect (`r apa_print(ttestBF(na.omit(E1.slopes_wide$color_absence1-E1.slopes_wide$color_absence2)))$statistic`).

*Hypothesis 5*: In case of a learning effect for pop-out search, Hypothesis 5 was designed to test the specificity of this effect to color pop-out by computing an interaction between block number and search type. Given that no learning effect was observed, this test makes little sense. For completeness, we report that the change in slope between blocks 1 and 3 was similar for color and conjunction search (`r apa_print(t.test(E1.slopes_wide$color_absence1-E1.slopes_wide$color_absence2-E1.slopes_wide$conjunction_absence1+E1.slopes_wide$conjunction_absence2,na.rm=TRUE))$full_result`). 


(ref:mainResultsCaption) Main Results for Expeiments 1 (A) and 2 (B). Upper panel: median search time by distractor set size for the two search tasks across the three blocks (12 trials per participant). Correct responses only. Lower panel: accuracy as a function of block, set size and search type. Error bars represent the standard error of the median (estimated with bootstrapping). Significance stars correspond to the difference in slope between conjunction and feature search within a block. \*: p<0.5, \* \* : p<0.01, \* \* \* : p<0.001

```{r termination-resultsMain, echo=FALSE, out.width = "\\textwidth", fig.cap="(ref:mainResultsCaption)", fig.scap="Search time and accuracy, Exp. 1 and 2"}
block_names <-  c("Block 1 (Absence)", "Block 2 (Presence)", "Block 3 (Absence)");
names(block_names) <- c("absence1", "presence1", "absence2");

RTplot <- ggplot(data=E1.median_search_times, 
       aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) +
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5, alpha=0.8) +
  scale_shape_manual(values=c(4,21))+
  scale_fill_manual(values = c("black","#377eb8"))+
  scale_color_manual(values = c("black","#377eb8"))+
  scale_linetype_manual(values=c("21", "solid","21"))+
  facet_grid(cols = vars(test_part))+
  geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=1.2, color="black") +
  facet_grid(cols = vars(test_part), 
             labeller = labeller(test_part = block_names))+
  labs(x='set size',y='median RT (seconds)', title='Experiment 1') + 
  theme_bw()+ 
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA))+
  guides(color = FALSE, linetype=FALSE) 

accplot <- ggplot(data=E1.mean_acc, 
       aes(x=set_size, y=mean_acc, fill=search_type)) +
  geom_bar(position='dodge',stat='identity') +
  theme_classic()+ 
  scale_fill_manual(values = c("black","#377eb8"))+
  facet_grid(cols = vars(test_part))+
  labs(x='set size',y='accuracy') +
  scale_x_continuous(breaks = c(4,8))+
  scale_y_continuous(breaks = c(0.5,1))+
  coord_cartesian(ylim=c(0.5,1)) +
  theme(legend.position='none')+ theme(strip.background = element_blank(),
   strip.text.x = element_blank())

# p <- plot_grid(RTplot,accplot,nrow=2,rel_heights=c(3,1))
# ggsave('figure/termination/results_Exp1.pdf',p,width=5,height=4.5)

knitr::include_graphics("figure/termination/Exps1_2.png")

```




```{r termination-first_trial_E1, echo=FALSE, cache=TRUE}

E1.first_trial_df <- E1_no_RT_exc.search_df %>%
  filter(trial==1)

E1.median_search_times_first_trial <- E1.first_trial_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_trial=mean(trial),median_RT= median(RT), num_trials=length(RT),
            sem_RT=bootstrap_error(RT,N_perm))%>%
  mutate(response=test_part=='presence1')

E1.search_slopes_first_trial <- E1.first_trial_df %>%
  group_by(search_type) %>%
  nest() %>%
  mutate(model = map(data, ~ lm(RT ~ set_size, data = .x)), 
         tidy = map(model, ~ tidy(.x))) %>%
  unnest(tidy) %>%
  filter(term == 'set_size') %>%
  dplyr::select(!c(data, model))

E1.anova_first_trial <- afex::aov_ez(
  data = E1.first_trial_df%>%filter(include==1)
  , dv = "RT"
  , between = c("search_type", "set_size")
  , id = "subj_id"
)


```


```{r termination-color_first, echo=FALSE, cache=TRUE}

E1.color_first_subjects <- E1.search_df %>%
  group_by(subj_id) %>%
  summarise(
    first_cond=search_type[trial==1], 
    second_cond=search_type[trial==2]) %>%
  filter(
    first_cond=='color' &
      second_cond=='color')

E1.color_first_df <- E1.search_df %>%
  filter(subj_id %in% E1.color_first_subjects$subj_id)

E1.median_search_times_color_first <- E1.color_first_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_trial=mean(trial),
            median_RT= median(RTfiltered), 
            num_trials=length(RT),
            sem_RT=se(RTfiltered)*1.2533)%>%
  mutate(response=test_part=='presence1')

E1.search_slopes_color_first <- E1.color_first_df %>%
  filter(include==1) %>%
  group_by(subj_id,search_type,test_part) %>%
  nest() %>%
  mutate(model = map(data, ~ lm(RTcorrected ~ set_size, data = .x)), 
         tidy = map(model, ~ tidy(.x))) %>%
  unnest(tidy) %>%
  filter(term == 'set_size') %>%
  dplyr::select(!c(data, model))

E1.slopes_wide_color_first <- pivot_wider(E1.search_slopes_color_first,
                           id_cols = 'subj_id',
                           names_from = c('search_type','test_part'),
                           values_from = estimate)

# block_names <-  c("Block 1 (Absence)", "Block 2 (Presence)", "Block 3 (Absence)");

# ggplot(data=median_search_times_color_first, 
#        aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) +
#   geom_line(size=1) +
#   geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5) +
#   scale_shape_manual(values=c(21,22))+
#   scale_fill_manual(values = c("#377eb8", "#e41a1c"))+
#   scale_color_manual(values = c("#377eb8", "#e41a1c"))+
#   scale_linetype_manual(values=c("21", "solid","21"))+
#   facet_grid(cols = vars(test_part))+
#   geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=0.6) +
#   facet_grid(cols = vars(test_part), 
#              labeller = labeller(test_part = block_names))+
#   labs(x='set size',y='median RT (seconds)', title='Search time curves') + 
#   theme_bw()+ 
#   scale_x_continuous(breaks = c(4,8))+
#   theme(legend.position='none',
#         legend.background = element_rect(fill=NA))+
#   guides(color = FALSE, linetype=FALSE) 
# 
# ggsave('color_first.png',dpi=300, width=7, height=5, units='in')
```

### Additional analysis: first trial only

We considered the possibility that our results do not reflect true absence pop-out without task experience, but instead might reflect participants' ability to rapidly adjust their termination times based on feedback from previous trials, even within the four trials of the first block. To rule out such within-block learning effects, we tested whether participants showed a color-absence pop-out effect on the very first trial of the experiment. To this end, we analyzed first trial response times as a function of search type (conjunction or color) and set-size. Since these first trials were slower overall (median RT in the first trial: `r E1.search_df%>%filter(trial==1)%>%pull(RT)%>%median()%>%printnum()` ms compared to `r E1.search_df%>%filter(trial==12)%>%pull(RT)%>%median()%>%printnum()` ms in the last trial), for this exploratory analysis we did not exclude trials based on response times. 

Even in this between-subject analysis, with only one trial per participant, we found a significant positive search slope for conjunction search (`r E1.search_slopes_first_trial%>%filter(search_type=='conjunction')%>%pull(estimate)%>%printnum()` ms/item, $p<0.01$), but not for color search (`r E1.search_slopes_first_trial%>%filter(search_type=='color')%>%pull(estimate)%>%printnum()` ms/item, $p=.43$). The difference in slopes between conjunction and color, quantified as the interaction between set size and search type in a two-way between-subject analysis of variance, was also significant (`r apa_print(E1.anova_first_trial)$full_result$search_type_set_size`; see Fig. \@ref(fig:termination-firstTrial)A). In other words, a color-absence pop-out  was already detectable in the very first trial of the experiment.

(ref:firstTrialCaption) Median search time by distractor set size for Experiments 1 and 2, looking at the first trial of each participant only. Same conventions as in Fig. \@ref(fig:termination-resultsMain).

```{r termination-firstTrial, echo=FALSE, out.width="100%", fig.cap="(ref:firstTrialCaption)", fig.scap="First-trial analysis"}

knitr::include_graphics("figure/termination/results_first_trials_with_stars.png")

```


```{r termination-noerrors, echo=FALSE, cache=TRUE, eval=FALSE}

E1.no_errors_subjects <-E1.search_df %>%
  group_by(subj_id) %>%
  summarise(
    numcorrect=sum(correct)) %>%
  filter(
    numcorrect==12)

E1.no_errors_df <- E1.search_df %>%
  filter(subj_id %in% E1.no_errors_subjects$subj_id)

E1.median_search_times_no_errors <- E1.no_errors_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_trial=mean(trial),
            median_RT= median(RTfiltered),
            num_trials=length(RT),
            sem_RT=se(RTfiltered)*1.2533)%>%
  mutate(response=test_part=='presence1')

E1.search_slopes_no_errors <- E1.no_errors_df %>%
  filter(include==1) %>%
  group_by(search_type) %>%
  do(model=lm(RT~set_size,data=.)) %>%
  tidy(model) %>%
  filter(term=='set_size')

block_names <-  c("Block 1 (Absence)", "Block 2 (Presence)", "Block 3 (Absence)");

# names(block_names) <- c("absence1", "presence1", "absence2");
# ggplot(data=median_search_times_no_errors,
#        aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) +
#   geom_line(size=1) +
#   geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5) +
#   scale_shape_manual(values=c(21,22))+
#   scale_fill_manual(values = c("#377eb8", "#e41a1c"))+
#   scale_color_manual(values = c("#377eb8", "#e41a1c"))+
#   scale_linetype_manual(values=c("21", "solid","21"))+
#   facet_grid(cols = vars(test_part))+
#   geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=0.6) +
#   facet_grid(cols = vars(test_part),
#              labeller = labeller(test_part = block_names))+
#   labs(x='set size',y='median RT (seconds)', title='Search time curves') +
#   theme_bw()+
#   scale_x_continuous(breaks = c(4,8))+
#   theme(legend.position='none',
#         legend.background = element_rect(fill=NA))+
#   guides(color = FALSE, linetype=FALSE)
# 
# ggsave('no_errors.png',dpi=300, width=7, height=5, units='in')
```

## Experiment 2

Experiment 1 provided unequivocal evidence that color-absence pop-out occurs prior to experiencing color pop-out in the context of the same task. Experiment 2 was designed to extend these findings to another stimulus feature that is also found to efficiently guide attention: shape. Unlike colour space, which spans three dimensions only, the space of possible shapes is relatively unconstrained such that having prior knowledge of the expected effect of different shapes on attention might require a richer mental model of attentional processes. Furthermore, colour is agreed to be a 'guiding attribute of attention', while it is unclear which shape features guide attention [@wolfe2017five]. In this experiment we also included an additional control for prior experience with visual search tasks, and asked if knowledge about search efficiency is available for explicit metacognitive report.

```{r termination_load_and_format_data_Exp2, echo=FALSE, cache=TRUE}

E2.df <- read_csv('data/termination/exp2/jatos_results_batch1.csv', lazy=FALSE) %>%
  rename('subj_id' = 'subject_identifier') %>%
  mutate(subj_id=factor(subj_id))

E2.export <- read_csv('data/termination/exp2/prolific_export_batch1.csv', lazy=FALSE) %>%
  filter(status=='APPROVED')

E2.N_total <- E2.df$subj_id%>%unique()%>%length()

#subjective estimates of search difficulty
E2.estimates <- E2.df %>%
  filter(test_part=='sort_trial') %>%
  dplyr::select(
    subj_id,
    final_locations) %>%
  mutate(final_locations = map(final_locations, ~ fromJSON(.) %>%
                                 as.data.frame())) %>%
  unnest(final_locations) %>%
  #only include stimulus name, no path or file extension.
  mutate(stimulus=substr(src,9,nchar(src)-4))%>%
  group_by(subj_id)%>%
  mutate(rank_x=rank(x),
         search_type=ifelse(stimulus=='shape4' | stimulus=='shape8','shape','conjunction'),
         set_size=ifelse(stimulus=='shape4' | stimulus=='conj4',4,8))%>%
  dplyr::select(subj_id,search_type,set_size,x, rank_x) 

#count how many times participants moved the boxes in the sorting trial.
E2.num_moves<- E2.df %>%
     filter(test_part=='sort_trial') %>%
     dplyr::select(
         subj_id,
         moves) %>%
     mutate(moves = map(moves, ~fromJSON(.) %>%
                          as.data.frame())) %>%
  unnest(moves) %>%
  group_by(subj_id) %>%
  tally() %>%
  #n represents the number of states, so the number of moves is n-1
  mutate(moves=n-1) 

#create a dataframe for prior experience responses
E2.prior_experience1 <- E2.df %>%
  filter(test_part=='prior_experience1') %>%
  dplyr::select('subj_id','responses') %>%
  mutate(responses =substr(responses,8,nchar(responses)-2))

E2.prior_experience2 <- E2.df %>%
  filter(test_part=='prior_experience2') %>%
  dplyr::select('subj_id','responses') %>%
  mutate(description=substr(responses,15,nchar(responses)-2))

E2.prior_experience <- merge(
  E2.prior_experience1,
  E2.prior_experience2,
  all=TRUE) %>%
  mutate(experience=ifelse(responses=='no','no',description)) %>%
  dplyr::select('subj_id','experience')

E2.search_df <- merge(E2.df,
                      E2.prior_experience) %>%
  filter((test_part=='absence1') | 
           (test_part=='absence2') | 
           (test_part=='presence1')) %>%
  dplyr::select('subj_id','test_part','set_size','target_present','correct','RT','search_type','experience') %>%
  #response was not coded directly, so is instead inferred from accuracy and stimulus
  mutate(response = ifelse(correct==1, target_present, 1-target_present)) %>%
  #in order to correct for serial position effects, I'm extracting a centered serial
  #position value for each trial in a block (-1.5,-0.5,0.5,1.5)
  mutate(trial = sequence(rle(as.character(subj_id))$lengths),
         i = trial%%4,
         i = ifelse(i==0,1.5,i-2.5),
         #convert to factor
         test_part = factor(test_part, levels = c('absence1','presence1','absence2')),
         search_type = factor(search_type, levels = c('conjunction','shape')))

##exclude subjects
E2.excluded <- E2.search_df %>%
  group_by(subj_id) %>%
  summarise(acc = mean(correct),
            RTlow = quantile(RT,0.25),
            RThigh = quantile(RT,0.75))%>%
  filter(acc<min_acc_search | RTlow<minRT | RThigh>maxRTsubj) %>%
  dplyr::select('subj_id')


##exclude subjects
E2_no_RT_exc.excluded <- E2.search_df %>%
  group_by(subj_id) %>%
  summarise(acc = mean(correct))%>%
  filter(acc<min_acc_search) %>%
  dplyr::select('subj_id')

E2.search_df <- E2.search_df %>%
  mutate( include=RT>minRT & 
            RT<maxRTtrial & correct==1 & 
            !subj_id%in%E2.excluded$subj_id,
          RTfiltered = ifelse(include, RT, NA)) %>%
  group_by(test_part) %>%
  do(mutate(.,RTcorrected = correctOrderEffects(.)))

E2_no_RT_exc.search_df <- E2.search_df %>%
  mutate( include=correct==1 & 
            !subj_id%in%E2_no_RT_exc.excluded$subj_id,
          RTfiltered = ifelse(include, RT, NA)) %>%
  group_by(test_part) %>%
  do(mutate(.,RTcorrected = correctOrderEffects(.)))

E2.descriptives <- E2.search_df %>% 
  filter(!subj_id%in%E2.excluded$subj_id) %>%
  group_by(subj_id) %>%
  summarise(accuracy=mean(correct), RT=median(RT))

E2.num_RT_exclusion_per_s <- E2.search_df %>%
  filter(RT>maxRTtrial | RT<minRT) %>%
  group_by(subj_id) %>%
  tally() %>%pull(n) %>%
  mean()

E2.num_error_exclusion_per_s <- E2.search_df %>%
  filter(correct==0) %>%
  group_by(subj_id) %>%
  tally() %>%pull(n) %>%
  mean()
```

### Participants

The research complied with all relevant ethical regulations, and was approved by the Research Ethics Committee of University College London (study ID number 1260/003). `r E2.N_total` Participants were recruited via Prolific, and gave their informed consent prior to their participation. They were selected based on their acceptance rate (>95%) and for being native English speakers. We collected data until we reached 320 included participants for hypotheses 1-4 (after applying our pre-registered exclusion criteria). The entire experiment took around 4 minutes to complete (median completion time in our pilot data: `r printnum(E2.export$time_taken%>%median()/60)` minutes). Participants were paid \Â£0.51 for their participation, equivalent to an hourly wage of \Â£`r printnum(0.51*3600/E2.export$time_taken%>%median())`.

### Procedure

A static version of Experiment 2 can be accessed on [matanmazor.github.io/termination](matanmazor.github.io/termination/experiments/demos/exp1/). Experiment 2 was identical to Experiment 1 with the following exceptions. First, instead of color search trials, we included shape search trials, where the red dot target is present or absent in an array of red squares. Second, to minimize the similarity between conjunction and shape searches, conjunction trials included blue dots and red triangles as distractors. Third, to test participants' explicit metacognition about their visual search behaviour, upon completing the main part of the task participants were presented with the four target-absent displays (shape and conjunction displays with 4 or 8 items), and were asked to sort them from fastest to slowest. Finally, participants reported whether they had participated in a similar experiment before, where they were asked to search for shapes on the screen. Participants who responded 'yes' were asked to tell us more about this previous experiment. This question was included in order to examine whether efficient target-absent search in trial 1 reflects prior experience with similar visual search experiments.

Our pre-registered analysis plan for Experiment 2, including rejection criteria and data preprocessing, was identical to our analysis plan for Experiment 1, and can be accessed in the following link: [https://osf.io/v6mnb](https://osf.io/v6mnb).

```{r analyze_data_E2, echo=FALSE, cache=TRUE}

E2.median_search_times <- E2.search_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_trial=mean(trial),median_RT= median(RTcorrected), 
            sem_RT=bootstrap_error(RTcorrected,N_perm))%>%
  mutate(response=test_part=='presence1')

E2.mean_acc <- E2.search_df %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_acc=mean(correct))%>%
  mutate(response=test_part=='presence1')

E2.search_slopes <- E2.search_df %>%
  filter(include==1) %>%
  group_by(subj_id,search_type,test_part) %>%
  do(model=lm(RTcorrected~set_size,data=.)) %>%
  mutate(tidys=list(broom::tidy(model))) %>%
  unnest(tidys) %>%
  filter(term=='set_size')

E2.mean_search_slopes <- E2.search_slopes %>%
  group_by(search_type,test_part) %>%
  summarise('mean_slope'=mean(estimate,na.rm=TRUE),
            'se_slope' = se(estimate, na.rm=TRUE))

E2.slopes_wide <- pivot_wider(E2.search_slopes,
                           id_cols = 'subj_id',
                           names_from = c('search_type','test_part'),
                           values_from = estimate) %>%
  mutate(double_shape_presence=2*shape_presence1,
         double_conjunction_presence=2*conjunction_presence1);
```
### Results

Overall mean accuracy was `r printnum(mean(E2.descriptives$accuracy))` (standard deviation =`r printnum(sd(E2.descriptives$accuracy))`). Median reaction time was `r printnum(median(E2.descriptives$RT))` ms (median absolute deviation = `r printnum(mad(E2.descriptives$RT))`). In all further analyses, only correct trials with response times between 250 and 1000 ms are included. 

*Hypothesis 1 (positive control)*: Search times in block 2 (target-present) followed the expected pattern, with a steep slope for conjunction search (`r apa_print(t.test(E2.slopes_wide$conjunction_presence1,na.rm=TRUE))$estimate`) and a shallow slope for shape search (`r apa_print(t.test(E2.slopes_wide$shape_presence1,na.rm=TRUE))$estimate`; see middle panel of Fig. \@ref(fig:termination-resultsMain)B). The slope for shape search was significantly lower than 10 ms/item and thus met our criterion for being considered 'pop-out' (`r apa_print(t.test(E2.slopes_wide$shape_presence1,na.rm=TRUE,mu=10,alternative='less'))$statistic`). Furthermore, the difference between the slopes was significant (`r apa_print(t.test(E2.slopes_wide$conjunction_presence1-E2.slopes_wide$shape_presence1,na.rm=TRUE))$statistic`). 

*Hypothesis 2*: Our central focus was on results from block 1 (target-absent). Here participants didn't yet have experience with finding the red dot. Similar to the second block, the slope for conjunction search was steep (`r apa_print(t.test(E2.slopes_wide$conjunction_absence1,na.rm=TRUE))$estimate`). The slope for shape search was numerically lower than 10 ms/item, but not significantly so (`r apa_print(t.test(E2.slopes_wide$shape_absence1,na.rm=TRUE,mu=10, alternative='less'))$full_result`). Still, the average search slope for shape search in this first block was significantly different from that of the conjunction search (`r apa_print(t.test(E2.slopes_wide$conjunction_absence1-E2.slopes_wide$shape_absence1,na.rm=TRUE))$statistic`; see leftmost panel of Fig. \@ref(fig:termination-resultsMain)B), indicating that a processing advantage for detecting the absence of a shape compared to the absence of shape-color conjunction was already in place before experience with target presence.

Moreover, this processing advantage was not different from what is expected based on shape search slope in block 2 (target presence). A conservative estimate for the ratio between target absence and target presence search slopes is 2 [@wolfe1998can]. Based on this ratio of 2 and the observed target-presence search slope of 6 ms/item, target absence search slope is expected to be 12 ms/item, or higher. Indeed, search slope for shape absence was not significantly different from, and numerically lower than, twice the search slope for shape presence as measured in block 2 (`r apa_print(t.test(E2.slopes_wide$shape_absence1-E2.slopes_wide$double_shape_presence))$statistic`; `r apa_print(ttestBF(na.omit(E2.slopes_wide$shape_absence1-E2.slopes_wide$double_shape_presence)))$statistic`). In other words, our failure to find a pop-out effect for shape absence was not due to participants being suboptimal in their quitting times, but because finding a red dot among red squares is truly more difficult than finding a red dot among blue dots. 

*Hypothesis 3*: As in the first block, in the third block the slope for shape search was numerically lower than 10 ms/item, but not significantly so (`r apa_print(t.test(E2.slopes_wide$shape_absence2,na.rm=TRUE,mu=10, alternative='less'))$full_result`). Importantly, the slope for shape search in block 3 was significantly different from the slope for conjunction search (`r apa_print(t.test(E2.slopes_wide$conjunction_absence2-E2.slopes_wide$shape_absence2,na.rm=TRUE))$statistic`) and not significantly different from twice the search slope for shape presence (`r apa_print(t.test(E2.slopes_wide$double_shape_presence-E2.slopes_wide$shape_absence2,na.rm=TRUE))$statistic`; `r apa_print(ttestBF(na.omit(E2.slopes_wide$shape_absence2-E2.slopes_wide$double_shape_presence)))$statistic`; see rightmost panel of Fig. \@ref(fig:termination-resultsMain)B).

*Hypothesis 4*: To quantify a potential learning effect for shape search between blocks 1 and 3, we directly contrasted the search slope for shape search in these two 'target-absent' blocks. We find no evidence for a learning effect (`r apa_print(t.test(E2.slopes_wide$shape_absence1-E2.slopes_wide$shape_absence2,na.rm=TRUE))$statistic`). Furthermore, a Bayesian t-test with a scaled Cauchy prior for effect sizes (r=0.707) provided strong evidence against a learning effect (`r apa_print(ttestBF(na.omit(E2.slopes_wide$shape_absence1-E2.slopes_wide$shape_absence2)))$statistic`). Like in Experiment 1, these results are most consistent with a *prior-knowledge only* model (see Fig. \@ref(fig:termination-models)), in which participants already know to expect that shape search should be easier than conjunction search, prior to having direct experience with target-present trials. 

```{r termination-exp2Plot, echo=FALSE}


RTplot <- ggplot(data=E2.median_search_times, 
       aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) +
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5, alpha=0.8) +
  scale_shape_manual(values=c(4,22))+
  scale_fill_manual(values = c('black',"#e41a1c"))+
  scale_color_manual(values = c('black',"#e41a1c"))+
  scale_linetype_manual(values=c("21", "solid","21"))+
  facet_grid(cols = vars(test_part))+
  geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=1.2,color='black') +
  facet_grid(cols = vars(test_part), 
             labeller = labeller(test_part = block_names))+
  labs(x='set size',y='median RT (seconds)', title='Experiment 2') + 
  theme_bw()+ 
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA))+
  guides(color = FALSE, linetype=FALSE) 

accplot <- ggplot(data=E2.mean_acc, 
       aes(x=set_size, y=mean_acc, fill=search_type)) +
  geom_bar(position='dodge',stat='identity') +
  theme_classic()+ 
  scale_fill_manual(values = c('black',"#e41a1c"))+
  facet_grid(cols = vars(test_part))+
  labs(x='set size',y='accuracy') +
  scale_x_continuous(breaks = c(4,8))+
  scale_y_continuous(breaks = c(0.5,1))+
  coord_cartesian(ylim=c(0.5,1)) +
  theme(legend.position='none')+ theme(strip.background = element_blank(),
   strip.text.x = element_blank())

p <- plot_grid(RTplot,accplot,nrow=2,rel_heights=c(3,1))

ggsave('figure/termination/results_Exp2.pdf',p,width=5,height=4.5)
# ggplot(data=mean_search_slopes, aes(x=search_type, y=mean_slope))+
#   geom_bar(aes(fill=search_type), stat="identity",show.legend = FALSE)+
#   geom_errorbar(aes(ymin=mean_slope-se_slope, ymax=mean_slope+se_slope), width=.2)+
#   facet_grid(cols=vars(test_part))+
#   labs(y='mean slope (ms/item)', title='Search slopes')+
#   theme_minimal()
```

### Additional Analyses

#### First trial only {-}


```{r first_trial_E2, echo=FALSE, cache=TRUE}

E2.first_trial_df <- E2_no_RT_exc.search_df %>%
  filter(trial==1)

E2.median_search_times_first_trial <- E2.first_trial_df %>%
  filter(include==1) %>%
  group_by(test_part,set_size,search_type) %>%
  summarise(mean_trial=mean(trial),median_RT= median(RT), num_trials=length(RT),
            sem_RT=bootstrap_error(RT,N_perm))%>%
  mutate(response=test_part=='presence1')

E2.search_slopes_first_trial <- E2.first_trial_df %>%
  filter(include==1) %>%
  group_by(search_type) %>%
  nest() %>%
  mutate(model = map(data, ~ lm(RT ~ set_size, data = .x)), 
         tidy = map(model, ~ tidy(.x))) %>%
  unnest(tidy) %>%
  filter(term == 'set_size') %>%
  dplyr::select(!c(data, model))

E2.anova_first_trial <- afex::aov_ez(
  data = E2.first_df <-E2.first_trial_df%>%filter(include==1)
  , dv = "RT"
  , between = c("search_type", "set_size")
  , id = "subj_id"
)

```


As in Exp. 1, here we also extended our pre-registered analysis with an exploratory between-subject analysis, focusing on the first trial of the experiment. Here too, we observed a significant positive search slope for conjunction search (`r E2.search_slopes_first_trial%>%filter(search_type=='conjunction')%>%pull(estimate)%>%printnum()` ms/item, $p<0.001$), but not for shape search (`r E2.search_slopes_first_trial%>%filter(search_type=='shape')%>%pull(estimate)%>%printnum()` ms/item, $p=.40$). The difference in slopes between conjunction and shape, quantified as the interaction between set size and search type in a two-way betwee-subject analysis of variance, was significant (`r apa_print(E2.anova_first_trial)$full_result$search_type_set_size`; see Fig. \@ref(fig:termination-firstTrial)B). This result reveals that efficient recognition of shape absence is already detectable in the very first trial of the experiment.

```{r termination-FirstTrial, echo=FALSE}

block_names <-  c("Block 1 (Absence)", "Block 2 (Presence)", "Block 3 (Absence)");

p1 <- ggplot(data=E1.median_search_times_first_trial, 
        aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) + 
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5, alpha=0.8) +
  scale_shape_manual(values=c(4,21))+
  scale_fill_manual(values = c("black","#377eb8"))+
  scale_color_manual(values = c("black","#377eb8"))+
  scale_linetype_manual(values=c("21", "solid","21"))+
  geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=1.2, color="black") +
  labs(x='set size',y='median RT (seconds)', title='First trial only (Exp. 1)') +
  theme_bw()+
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA))+
  guides(color = FALSE, linetype=FALSE)

p2 <- ggplot(data=E2.median_search_times_first_trial, 
        aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=test_part)) + 
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5, alpha=0.8) +
  scale_shape_manual(values=c(4,22))+
  scale_fill_manual(values = c('black',"#e41a1c"))+
  scale_color_manual(values = c('black',"#e41a1c"))+
  scale_linetype_manual(values=c("21", "solid","21"))+
  geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=1.2,color='black') +
  labs(x='set size',y='median RT (seconds)', title='First trial only (Exp. 2)') +
  theme_bw()+
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA))+
  guides(color = FALSE, linetype=FALSE)

p <- plot_grid(p1,p2,nrow=1)
ggsave('figure/termination/results_first_trials.pdf',p, width=5,height=3.5)

```

#### Task experience {-}

```{r analyze_experience_E2, echo=FALSE, cache=TRUE}

E2.no_experience <- E2.prior_experience1 %>%
  filter(responses=='no') %>%
  '$'(subj_id)

E2.search_slopes_no_experience <- E2.slopes_wide %>%
  filter(subj_id%in%E2.no_experience)
  
```

At the end of the experiment, participants were asked if they have ever participated in a similar experiment before, where they were asked to search for a target item. `r length(E2.no_experience)` out of `r E2.search_df$subj_id%>%unique()%>%length()` participants answered 'no' to this question. For those participants, a highly efficient search for a distinct shape in the first trials of the experiment, if found, cannot be due to prior experience of performing a visual search task with similar stimuli. Notably, however, participants who reported having no prior experience with a visual search task still showed efficient search termination for shape distractors (`r apa_print(t.test(E2.search_slopes_no_experience$shape_absence1,na.rm=TRUE,mu=10))$estimate`), and were significantly more efficient in terminating shape search than conjunction search in the first 4 target-absent trials (`r apa_print(t.test(E2.search_slopes_no_experience$conjunction_absence1-E2.search_slopes_no_experience$shape_absence1,na.rm=TRUE))$statistic`). Efficient search termination for shape search is therefore not dependent on prior visual search trials, neither within the same experiment nor in previous ones. 

#### Search time estimates {-}

```{r termination_analyze_estimates_E2, echo=FALSE, cache=TRUE}

#only analyze participants that made at least one move
moved <- E2.num_moves %>%
  filter(moves>0) %>%
  '$'(subj_id)

E2.median_estimates <- E2.estimates %>%
  filter(subj_id%in%moved) %>%
  group_by(set_size,search_type) %>%
  summarise(median_estimate= median(x), 
            sem_estimate=se(x)*1.2533)

E2.estimate_by_search_type <- E2.estimates %>%
    filter(subj_id%in%moved) %>%
  dplyr::select(subj_id,search_type,x) %>%
  group_by(subj_id,search_type) %>%
  summarise(x=mean(x)) %>%
  spread(key=search_type,value=x) %>%
  mutate(diff=conjunction-shape)

E2.estimate_by_set_size <- E2.estimates %>%
    filter(subj_id%in%moved) %>%
  dplyr::select(subj_id,set_size,x) %>%
  group_by(subj_id,set_size) %>%
  summarise(x=mean(x)) %>%
  spread(key=set_size,value=x,sep='') %>%
  mutate(diff=set_size8-set_size4)

E2.estimate_slopes <- E2.estimates %>%
  filter(subj_id%in%moved) %>%
  group_by(subj_id,search_type) %>%
  nest() %>%
  mutate(model = map(data, ~ lm(x ~ set_size, data = .x)), 
         tidy = map(model, ~ tidy(.x))) %>%
  unnest(tidy) %>%
  filter(term == 'set_size') %>%
  dplyr::select(c(subj_id,search_type,estimate))%>%
  pivot_wider(
    id_cols = 'subj_id',
    names_from = c('search_type'),
    values_from = estimate
  )

E2.slopes_by_resp <- E2.search_df %>%
    filter(include==1) %>%
    group_by(subj_id,search_type,response) %>%
    nest() %>%
  mutate(model = map(data, ~ lm(RTcorrected ~ set_size, data = .x)), 
         tidy = map(model, ~ tidy(.x))) %>%
  unnest(tidy) %>%
    filter(term=='set_size')%>%
  dplyr::select(subj_id,search_type,response,estimate)%>%
  pivot_wider(id_cols = 'subj_id',
                           names_from = c('search_type','response'),
                           values_from = estimate)

# Both search slopes and estimated slopes
E2.all_slopes <- na.omit(merge(E2.estimate_slopes,E2.slopes_wide)%>%merge(E2.slopes_by_resp));

E2.all_slopes_no_insight <- E2.all_slopes%>%filter(shape>conjunction);

E2.no_insight_subjects <- E2.all_slopes_no_insight %>%
  pull(subj_id);

E2.median_estimates_no_insight <- E2.estimates %>%
  filter(subj_id%in%moved & subj_id%in%E2.no_insight_subjects) %>%
  group_by(set_size,search_type) %>%
  summarise(median_estimate= median(x), 
            sem_estimate=se(x)*1.2533)

# filter participants that rated conjunction4 as slower than shape8
E2.correct_estimates <- E2.estimates %>%
  pivot_wider(id_cols=subj_id,
              names_from=c('search_type','set_size'),
              values_from=x) %>%
  filter(conjunction_4<shape_8) %>%
  '$'(subj_id)



p <- ggplot(data=E2.median_estimates,
       aes(x=set_size, y=median_estimate, color=search_type, fill=search_type)) +
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5) +
  scale_shape_manual(values=c(4,22))+
  scale_fill_manual(values = c('black',"#e41a1c"))+
  scale_color_manual(values = c('black',"#e41a1c"))+
  geom_errorbar(aes(ymin=median_estimate-sem_estimate,
                    ymax=median_estimate+sem_estimate),linetype="solid", width=0.6) +
  labs(x='set size',y='estimated difficulty (a.u.)', title='Difficulty estimates:\nall subjects') +
  theme_bw()+
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA),
        axis.text.y = element_blank())+
  guides(color = FALSE, linetype=FALSE)
ggsave('figure/termination/estimates.pdf',p,width=2.5,height=4.2)

p <- ggplot(data=E2.median_estimates_no_insight,
       aes(x=set_size, y=median_estimate, color=search_type, fill=search_type)) +
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5) +
  scale_shape_manual(values=c(4,22))+
  scale_fill_manual(values = c('black',"#e41a1c"))+
  scale_color_manual(values = c('black',"#e41a1c"))+
  geom_errorbar(aes(ymin=median_estimate-sem_estimate,
                    ymax=median_estimate+sem_estimate),linetype="solid", width=0.6) +
  labs(x='set size',y='estimated difficulty (a.u.)', title='Difficulty estimates:\nno metacognitive insight') +
  theme_bw()+
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA),
        axis.text.y = element_blank())+
  guides(color = FALSE, linetype=FALSE)
ggsave('figure/termination/estimates_no_insight.pdf',p, width=2.5,height=4.2)


E2.median_search_times_no_insight <- E2.search_df %>%
  mutate(response=ifelse(test_part=='presence1','present','absent')) %>%
  filter(include==1 & subj_id%in%E2.no_insight_subjects) %>%
  group_by(response,set_size,search_type, subj_id) %>%
  summarise(RT=mean(RTcorrected))%>%
  group_by(response,set_size,search_type)%>%
  summarise(median_RT= median(RT), 
            sem_RT=bootstrap_error(RT,N_perm))

RTplot <- ggplot(data=E2.median_search_times_no_insight, 
       aes(x=set_size, y=median_RT, color=search_type, fill=search_type, linetype=response)) +
  geom_line(size=1) +
  geom_point(aes(shape = search_type), size=4, color="black",stroke=1.5, alpha=0.8) +
  scale_shape_manual(values=c(4,22))+
  scale_fill_manual(values = c('black',"#e41a1c"))+
  scale_color_manual(values = c('black',"#e41a1c"))+
  scale_linetype_manual(values=c("21", "solid","21"))+
  geom_errorbar(aes(ymin=median_RT-sem_RT,ymax=median_RT+sem_RT),linetype="solid", width=1.2,color='black') +
  facet_grid(cols = vars(response))+
  labs(x='set size',y='median RT (seconds)', title='Search times for participant with no insight') + 
  theme_bw()+ 
  scale_x_continuous(breaks = c(4,8))+
  theme(legend.position='none',
        legend.background = element_rect(fill=NA))+
  guides(color = FALSE, linetype=FALSE) 

E2.mean_acc_no_insight <- E2.search_df %>%
  mutate(response=ifelse(test_part=='presence1','present','absent')) %>%
  filter(subj_id%in%E2.no_insight_subjects)%>%
  group_by(response,set_size,search_type) %>%
  summarise(mean_acc=mean(correct))

accplot <- ggplot(data=E2.mean_acc_no_insight, 
       aes(x=set_size, y=mean_acc, fill=search_type)) +
  geom_bar(position='dodge',stat='identity') +
  theme_classic()+ 
  scale_fill_manual(values = c('black',"#e41a1c"))+
  facet_grid(cols = vars(response))+
  labs(x='set size',y='accuracy') +
  scale_x_continuous(breaks = c(4,8))+
  scale_y_continuous(breaks = c(0.5,1))+
  coord_cartesian(ylim=c(0.5,1)) +
  theme(legend.position='none')+ theme(strip.background = element_blank(),
   strip.text.x = element_blank())

p <- plot_grid(RTplot,accplot,nrow=2,rel_heights=c(3,1))

ggsave('figure/termination/results_Exp2_no_insight.pdf',width=4,height=4.5)

```


(ref:estimatesCaption) A: After completing the visual search component of Experiment 2, participants were asked to position the four searches (shape and conjunction searches with 4 or 8 distractors) on a perceived difficulty axis. B. As a group, participants' estimates revealed metacognitive knowledge of the set size effect and of the fact that shape search is harder. C. A subset of 84 participants erroneously believed that shape search was more difficult than conjunction search. D. Even among these participants, search slopes in target-absence blocks followed the typical pattern, with a steeper slope for conjunction search. Same plotting conventions as Fig. \@ref(fig:termination-resultsMain).

```{r termination-estimates, echo=FALSE, out.width="\\textwidth", fig.cap="(ref:estimatesCaption)", fig.scap="Retrospective search time estimates"}

knitr::include_graphics("figure/termination/metacognitive_ratings.png")

```

Upon completing the main part of Experiment 2, participants positioned the four search arrays (shape and conjunction searches with 4 or 8 distractors) on a perceived difficulty axis (see Fig. \@ref(fig:termination-estimates)A). We used these difficulty ratings to ask whether the advantage for detecting the absence of a distinct shape over the absence of a shape/color conjunction depended on explicit access to metacognitive knowledge about search difficulty. The decision to quit early in shape-absent trials may depend on an internal belief that the target shape would have drawn attention immediately, but this belief may be inaccessible to introspection. If introspective access is not a necessary condition for efficient quitting in visual search, some participants may not be able to reliably introspect about the difficulty of different searches but still be able to quit efficiently in shape search.

For this analysis, we only considered the ratings of participants who engaged with the array-sorting trial, and moved some of the arrays before continuing to the next trial (N=`r length(moved)`). Searches with 8 distractors were rated as more difficult than searches with 4 distractors, in line with the set-size effect (`r apa_print(t.test(E2.estimate_by_set_size$diff))$statistic`). Furthermore, conjunction searches were rated as more difficult than shape searches (`r apa_print(t.test(E2.estimate_by_search_type$diff))$statistic`). Finally, we fitted single-subject linear regression models to the two search types, predicting search-time estimates (the position of each condition on a continuous perceived difficulty scale) as a function of set size. Similar to actual search slopes, these slopes derived from subjective estimates were also shallower for shape than for conjunction search, reflecting a belief that the effect of set size in shape search is not as strong as the effect of set size in conjunction search (`r apa_print(t.test(E2.estimate_slopes$conjunction-E2.estimate_slopes$shape))$full_result`; see Fig. \@ref(fig:termination-estimates)B).

Subjective search time estimates revealed that by the end of the experiment, the average participant considered the slope of shape search to be shallower than that of conjunction search. This suggests that at least some participants had introspective access to their visual search behaviour. But were those participants whose estimates reflected a shallow slope for shape search the same ones that were more efficient in detecting the absence of a shape in the display? The slopes of retrospective estimates for shape search were not reliably correlated with actual search slopes for shape absence in block 1 (`r apa_print(cor.test(E2.all_slopes$shape,E2.all_slopes$shape_absence1))$estimate`) or 2 (`r apa_print(cor.test(E2.all_slopes$shape,E2.all_slopes$shape_absence2))$estimate`). However, this result should be interpreted carefully in light of the low reliability of single subject estimates that are derived from one trial per cell. Indeed, search slopes for shape absence in blocks 1 and 3 were not reliably correlated themselves (`r apa_print(cor.test(E2.all_slopes$shape_absence1,E2.all_slopes$shape_absence2))$estimate`). 

To answer this question using a more severe test [@mayo2018statistical], we focused on the subset of participants whose difficulty orderings reflected the erroneous belief that shape search was more difficult than conjunction search ($N=$ `r E2.all_slopes_no_insight%>%nrow()`; see Fig. \@ref(fig:termination-estimates)C). If efficient search termination depends on accurate explicit metacognitive knowledge about search efficiency, search termination in this subset of participants is not expected to be more efficient in shape compared to conjunction search, and is even expected to show the opposite pattern. In contrast with this prediction, search slopes for shape-absence trials were shallower than for conjunction-absence trials (`r apa_print(t.test(E2.all_slopes_no_insight$conjunction_0,E2.all_slopes_no_insight$shape_0, paired=TRUE))$full_result`; see Fig. \@ref(fig:termination-estimates)D). This indicates that efficient identification of shape absence is not dependent on explicit metacognitive knowledge about search efficiency.

## Discussion

How do people decide that a target is absent from a visual scene? In this study we considered three candidate answers to this question: counterfactual reasoning ("I would have detected the target if it were present"), ensemble perception ("I immediately see that the target is missing") and task heuristics ("Based on previous trials, responding now would balance accuracy and response time"). The third option is different from the first two: while a heuristic calibration of a termination rule may shape search behaviour in classic lab-based experiments comprised of many repetitive trials, it is not available to subjects in one-shot searches in their everyday lives, nor is it available to them in the first trial of the experiment.  

To isolate the effect of previous trials on search termination, we focused on the first trials of a visual search task, before participants experience finding the target. Across two experiments, we found that no prior experience with color or shape pop-out in previous trials was needed for participants to be able to terminate the search early when a target would have been found immediately. In other words, participants were sensitive to the counterfactual efficiency with which a hypothetical target would have been detected even in the first trials of the experiment. This result rules out a purely heuristic-based account of search termination and suggests that in these first few trials, participants are relying on prior second-order knowledge about visual attention (e.g., 'red pops out', or 'a dot would catch my attention'), on a pre-attentional identification of target absence via ensemble statistics, or on a combination of the two. 

Do participants employ a counterfactual heuristic, drawing on implicit metacognitive knowledge about search efficiency, or instead immediately perceive the absence of a target via ensemble scene statistics? We suggest that without second-order knowledge of their own perception and attention, ensemble perception alone is not sufficient to account for absence pop-out. Ensemble perception allows observers to extract summary statistical information from sets of similar stimuli, without directly perceiving any single stimulus [@whitney2018ensemble]. According to this account, if participants immediately perceive that the search array comprises only squares, they might not need to rely on any counterfactual thinking or self-knowledge to conclude that no circle was present. Importantly, however, for the global statistical property 'the array comprises only squares' to be extracted from a display without representing individual squares, the visual system must represent, explicitly or implicitly, that a non-square item would have been detected by the visual system if they had been present. This second-order representation can be implemented, for example, as a threshold on curvature-sensitive neurons ('a round object would have induced a higher firing rate in this neuron population'), or more generally as a likelihood function going from polygons to firing patterns ('The perceived input is most likely under a world state where the display includes only polygons'). 

As an illustration, assume that Sarah, a participant in our experiment, does not know that a red item would immediately catch her attention in an array of blue distractors. Not only can Sarah not report this fact, this knowledge is not represented and cannot influence her cognitive system. Sarah is now searching for a red dot, and sees a uniform array of blue dots. How can she know that she hasn't missed a red dot? In the absence of second-order knowledge about search efficiency, Sarah would have to scan the dots one by one before committing to a 'target absent' response. Therefore, whether or not ensemble perception plays a role in absence pop-out, second-order knowledge about search efficiency is necessary to exlain the effects we observe.


Should this second-order knowledge be considered metacognitive? We argue that it should, and note that it is not a prerequisite for metacognitive knowledge to be accessible to consciousness. Metacognitive knowledge was originally assumed by Flavell -@flavell1979metacognition to mostly affect cognition without accessing consciousness at all (i.e. without inducing a 'metacognitive experience'). Different aspects of metacognitive monitoring, including an immediate *Feeling of Knowing* when presented with a problem, have been attributed to implicit metacognitive mechanisms that share a conceptual similarity with the ones described in the previous paragraph [@reder1996metacognition]. Indeed, metacognitive knowledge is sometimes measured as an ability to flexibly adapt information gathering thresholds: similar to a decision to terminate a search, the decision to stop gathering more information is widely accepted to be guided by metacognitive factors in developmental [@siegel2021children; @leckey2020response] and comparative [@watanabe2014western] psychology.

Our findings complement and extend previous work in which participants had introspective awareness of attentional capture [@adams2020assessing; @adams2021introspective]: our results suggest that on top of the ability to monitor attention, people also hold valid second-order knowledge about attentional processes, that allows them to make predictions and guide their information gathering decisions. A schematic model of attention has been suggested to be implemented in the brains of many animal species, including all mammals and birds, and to facilitate attention control and monitoring [@graziano2013consciousness]. This kind of implicit second-order knowledge, perhaps together with a capacity to extract ensemble statistics from a display, may be crucial for representing the *absence* of objects. The critical difference between inferring *X is absent* and simply lacking the belief *X is present* is a counterfactual belief that *X* would have been detected, had it been presented [@mazor2020distinguishing; @mazor2021inference]. In turn, studying the processes underpinning efficient inference about absence can shed light on the role of higher-order representations in perception - because such counterfactual beliefs rest on representing, perhaps implicitly, how one's own perceptual system might respond under various conditions.

## Conclusion

Our findings reveal that some knowledge about search efficiency is available to participants already in the first trials of the experiment, before engaging with the task or knowing what distractors to expect. These results reflect the same qualitative response time patterns as those commonly obtained in typical (few subjects/many trials) visual search experiments. Given that no target was present in these trials, participants must have been sensitive to the counterfactual likelihood of them finding the target, had it been present. In Experiment 2 we showed that this second-order knowledge about search difficulty was often accessible to report, but that this was not a necessary condition for efficient search termination. We conclude that efficient inference about absence is critically dependent on implicit second-order knowledge about visual search. In the next chapter I look more closely at participants' explicit second-order knowledge of their visual search behaviour, by asking for prospective search-time estimates for unfamiliar, complex stimuli. 

